name: Simple Deadline Collector

on:
  schedule:
    # Runs every day at 9:00 AM UTC
    - cron: '0 9 * * *'

  # Allows manual run from Actions tab
  workflow_dispatch:

jobs:
  run-collector:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run article collection
      run: |
        python collector.py

    - name: Display statistics
      run: |
        python collector.py --stats

    - name: Export to JSON
      run: |
        python collector.py --export-json

    # --- Year-end: runs only on Dec 26 ---
    - name: Year-end archive and reset
      run: |
        MONTH=$(date -u +%m)
        DAY=$(date -u +%d)
        YEAR=$(date -u +%Y)

        if [ "$MONTH" = "12" ] && [ "$DAY" = "26" ]; then
          echo "üóÇÔ∏è Dec 26 detected ‚Äî running year-end archive..."
          python - <<EOF
        import json, shutil
        from pathlib import Path

        src = Path("data/articles.json")
        if src.exists():
            with open(src) as f:
                data = json.load(f)
            year = data.get("meta", {}).get("year", "$YEAR")
            archive = Path(f"data/articles_{year}.json")
            shutil.copy(src, archive)
            print(f"Archived to {archive}")
            new_year = int(year) + 1
            empty = {"meta": {"year": new_year, "total_articles": 0, "last_updated": "", "new_this_run": 0}, "articles": []}
            with open(src, "w") as f:
                json.dump(empty, f, indent=2)
            print(f"Reset articles.json for {new_year}")
        EOF
          echo "YEAR_END=true" >> $GITHUB_ENV
        else
          echo "Not Dec 26, skipping year-end archive."
          echo "YEAR_END=false" >> $GITHUB_ENV
        fi

    - name: Commit and push data
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add data/
        git diff --staged --quiet || git commit -m "Daily update: deadline articles $(date -u '+%Y-%m-%d')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Open a GitHub Issue on Dec 26 as confirmation
    - name: Open year-end notification issue
      if: env.YEAR_END == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const year = new Date().getFullYear() - 1;
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üóÇÔ∏è Year-End Complete: ${year} archived, ${year + 1} ready`,
            body: `## Year-End Archive Complete\n\nThe workflow has automatically:\n- ‚úÖ Archived \`articles.json\` ‚Üí \`data/articles_${year}.json\`\n- ‚úÖ Reset \`articles.json\` for ${year + 1}\n\nYou're all set for the new year. Nothing else to do!\n\n> _Auto-generated by the deadline-collector workflow._`
          });

    # Keep artifact as backup
    - name: Upload CSV exports as artifact
      uses: actions/upload-artifact@v4
      with:
        name: deadline-articles
        path: exports/*.csv
